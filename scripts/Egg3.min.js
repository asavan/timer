var Egg = {
    name: "EggTimer",
    defaultText: "",
    expiredMessage: "",
    title: "",
    label: "",
    progress: 0,
    startTime: 0,
    endTime: 0,
    totalTime: 0,
    parseError: "",
    progressBar: null,
    progressText: null,
    staticArea: null,
    beep: null,
    currDate: null,
    endDate: null,
    ticker: null,
    startButton: null,
    volume: 1,
    sequence: [],
    canAlert: true,
    start: function() {
        if (Egg.sequence.length === 0) {
            Egg.initializeTimer2("Time Expired!")
        } else {
            var first = Egg.sequence.shift();
            Egg.initializeTimer(0, first.duration * 1e3, first.label)
        }
    },
    initializeTimer: function(startTime, endTime, label) {
        Egg.endTime = endTime;
        Egg.startTime = startTime;
        Egg.label = label;
        Egg.totalTime = Egg.endTime - Egg.startTime;
        Egg.endDate = new Date((new Date).getTime() + Egg.totalTime);
        Egg.currDate = new Date;
        Egg.expiredMessage = Egg.expiredMessage || "Time Expired" + (label ? ": " : "!") + label;
        Egg.update();
        if (!Egg.ticker) {
            Egg.ticker = setInterval(Egg.update, 1e3 / 4)
        }
    },
    initializeTimer2: function(label) {
        Egg.endDate = new Date((new Date).getTime() + Egg.totalTime);
        Egg.currDate = new Date;
        Egg.expiredMessage = label || Egg.expiredMessage;
        Egg.update();
        if (!Egg.ticker) {
            Egg.ticker = setInterval(Egg.update, 1e3 / 4)
        }
    },
    update: function() {
        Time.calcTime(new Date(), Egg.endDate);
        Egg.updateParts(Time)
    },
    updateParts: function(Time) {
        if (Time.totalSeconds < 0) {
            Egg.onTimeComplete();
            return
        }
        var clockTime = [];
        var yearText, monthText, dayText, hourText, minText, secText;
        yearText = monthText = dayText = hourText = minText = secText = "";
        if (Time.remainingHours > 0) {
            clockTime.push(padTimeText(Time.remainingHours) + "h");
            hourText = getTimeText(Time.remainingHours, "hour")
        }
        if (Time.remainingMinutes > 0) {
            clockTime.push(Time.remainingMinutes);
            minText = getTimeText(Time.remainingMinutes, "minute")
        } else {
            clockTime.push(padTimeText(0))
        }
        if (Time.remainingSeconds > 0) {
            clockTime.push(padTimeText(Time.remainingSeconds));
            secText = getTimeText(Time.remainingSeconds, "second")
        } else {
            clockTime.push(padTimeText(0))
        }
        var slabel = Egg.label && Egg.label != "" ? Egg.label + "<br />" : "";
        var timeText = slabel + yearText + monthText + dayText + hourText + minText + secText;
        let title = clockTime.join(":") + (Egg.label && Egg.label !== "" ? " : " + Egg.label : "");
        Egg.updateTitle(title);
        Egg.updateText(title);
        Egg.progress = (Egg.totalTime - Time.totalMilliseconds) / Egg.totalTime;
        Egg.updateProgressBar();
        // Egg.currDate = new Date
    },
    updateTitle: function(title) {
        document.title = title + " - E.ggtimer"
    },
    updateProgressBar: function() {
        var wWidth = $(window).width();
        var wHeight = $(window).height();
        if (Egg.progressBar) {
            Egg.progressBar.width(wWidth * Egg.progress)
        }
    },
    updateText: function(text) {
        if (text) Egg.progressText.html(text)
    },
    onTimeComplete: function() {
        var beepFinishedPromise = null;
        Egg.progress = 1;
        Egg.updateProgressBar();
        if (Egg.beep && Egg.beep.play) {
            Egg.beep.volume = Egg.volume;
            beepFinishedPromise = Egg.beep.play()
        }
        if (Egg.sequence.length === 0) {
            clearInterval(Egg.ticker);
            Egg.updateTitle(Egg.expiredMessage);
            Egg.updateText(Egg.expiredMessage);
            if (beepFinishedPromise && typeof beepFinishedPromise.then === "function") {
                beepFinishedPromise.then(function() {
                    Egg.showAlert();
                });
            } else {
                Egg.showAlert()
            }
        } else {
            var next = Egg.sequence.shift();
            Egg.initializeTimer(0, next.duration * 1e3, next.label)
        }
    },
    showAlert: function() {
        if (Egg.canAlert) {
            setTimeout(function() {
                alert(Egg.expiredMessage);
            }, 300);
        }
    }
};

function getSModifier(value) {
    var mod;
    if (value == 0) {
        mod = ""
    } else if (value == 1) {
        mod = " "
    } else {
        mod = "s "
    }
    return mod
}

function padTimeText(value) {
    return value < 10 ? "0" + value : "" + value
}

function getTimeText(time, label) {
    var timeText = "";
    if (time > 0) {
        timeText = time + " " + label + getSModifier(time);
    }
    return timeText;
}

$(function() {
    Egg.progressBar = $("#progress");
    Egg.staticArea = $("#static");
    Egg.staticArea.width($(window).width() - 20);
    Egg.staticArea.height($(window).height() - 20);
    Egg.progressText = $("#progressText");
    Egg.startButton = $("#tapButton");
    Egg.updateText("");
    Egg.beep = document.getElementById("beepbeep");
    $(window).bind("resize", window_RESIZE);
    
    window_RESIZE();
    var listener = function (event) {
        Egg.start();
        Egg.startButton.hide();
        document.body.removeEventListener('click', listener, false);
    };

    document.body.addEventListener('click', listener, false);
    Egg.endDate = new Date((new Date).getTime() + Egg.totalTime);
	Egg.update();

    if (Egg.beep && Egg.beep.load) {
        Egg.beep.load();
    }
    
});

function window_RESIZE(e) {
    Egg.staticArea.width($(window).width() - 20);
    Egg.staticArea.height($(window).height() - 20);
    Egg.updateText();
    Egg.updateProgressBar();
}
